{% extends "base.html" %}

{% load static %}

{% block extra_css %}
{% endblock extra_css %}

{% block content %}

{% include 'partials/navbar.html' %}

<main>
    <div class="container">
        <div class="row g-4">

            <!-- Sidenav START -->
            <div class="col-lg-3">
                {% include 'partials/sidenav.html' %}
            </div>
            <!-- Sidenav END -->

            <!-- Main content START -->
            <div class="col-md-8 col-lg-9 vstack gap-4">
                <!-- Card START -->
                <div class="card">
                    <!-- Card body START -->
                    <div class="card-body">
                        <div class="d-md-flex flex-wrap align-items-start text-center text-md-start">
                            <div class="mb-2">
                                <!-- Avatar -->
                                <div class="avatar avatar-xl">
                                    <img class="avatar-img border-0" src="{% static 'images/logo/placeholder.svg' %}"
                                        alt="">
                                </div>
                            </div>
                            <div class="ms-md-4 mt-3">
                                <!-- Info -->
                                <h1 class="h5 mb-0">{{ group.name }} <i
                                        class="bi bi-patch-check-fill text-success small"></i></h1>
                                <ul class="nav nav-divider justify-content-center justify-content-md-start">
                                    <li class="nav-item"> {% if group.is_private %}Private{% else %}Public{% endif %}
                                        group </li>
                                    <li class="nav-item"> {{ group.memberships.count }} members </li>
                                </ul>
                            </div>
                            <!-- Button -->
                            <div
                                class="d-flex justify-content-center justify-content-md-start align-items-center mt-3 ms-lg-auto">
                                {% if is_moderator %}
                                <span class="badge bg-primary me-2">Moderator</span>
                                {% elif is_member %}
                                <button class="btn btn-sm btn-primary-soft me-2" type="button"> <i
                                        class="bi bi-person-check-fill pe-1"></i> Joined</button>
                                {% else %}
                                <form action="{% url 'groups:group_join' group.pk %}" method="POST">
                                    {% csrf_token %}
                                    <button class="btn btn-sm btn-primary me-2" type="submit"> <i
                                            class="fa-solid fa-plus pe-1"></i> Join Group</button>
                                </form>
                                {% endif %}

                                {% if is_moderator or is_member %}
                                <button class="btn btn-sm btn-success me-2" type="button" data-bs-toggle="modal"
                                    data-bs-target="#modalInvite"> <i class="fa-solid fa-plus pe-1"></i> Invite</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <!-- Card body END -->
                    <div class="card-footer pb-0">
                        <ul class="nav nav-tabs nav-bottom-line justify-content-center justify-content-md-start mb-0">
                            <li class="nav-item"> <a class="nav-link active" data-bs-toggle="tab" href="#group-tab-1">
                                    Feed </a> </li>
                            <li class="nav-item"> <a class="nav-link" data-bs-toggle="tab" href="#group-tab-2"> About
                                </a> </li>
                            <li class="nav-item"> <a class="nav-link" data-bs-toggle="tab" href="#group-tab-3">
                                    Connections <span class="badge bg-success bg-opacity-10 text-success small">
                                        {{ members.count }}</span> </a> </li>
                            <li class="nav-item"> <a class="nav-link" data-bs-toggle="tab" href="#group-tab-4">
                                    Media</a> </li>
                            <li class="nav-item"> <a class="nav-link" data-bs-toggle="tab" href="#group-tab-5">
                                    Videos</a> </li>
                            {% if is_moderator %}
                            <li class="nav-item"> <a class="nav-link" data-bs-toggle="tab" href="#group-tab-moderation">
                                    Moderation <span class="badge bg-danger bg-opacity-10 text-danger small">
                                {{ pending_members.count }}</span> </a> </li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <!-- Card END -->

                <div class="tab-content pt-0 pb-0 mb-0">

                    <!-- Group Feed tab START -->
                    <div class="tab-pane show active fade" id="group-tab-1">
                        <div class="row g-4">
                            <div class="col-lg-8 vstack gap-4">
                                <!-- Share feed START -->
                                {% if is_member or is_moderator %}
                                <div class="card card-body">
                                    <div class="d-flex mb-3">
                                        <!-- Avatar -->
                                        <div class="avatar avatar-xs me-2">
                                            <a href="#"> <img class="avatar-img rounded-circle"
                                                    src="{% static 'images/avatar/placeholder.jpg' %}" alt=""> </a>
                                        </div>
                                        <!-- Post input -->
                                        <div class="w-100">
                                            <input class="form-control pe-4 border-0"
                                                placeholder="Share your thoughts..." data-bs-toggle="modal"
                                                data-bs-target="#modalCreateFeed">
                                        </div>
                                    </div>
                                    <!-- Share feed toolbar START -->
                                    <ul class="nav nav-pills nav-stack small fw-normal">
                                        <li class="nav-item">
                                            <a class="nav-link bg-light py-1 px-2 mb-0" href="#!" data-bs-toggle="modal"
                                                data-bs-target="#feedActionPhoto"> <i
                                                    class="bi bi-image-fill text-success pe-2"></i>Photo</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link bg-light py-1 px-2 mb-0" href="#!" data-bs-toggle="modal"
                                                data-bs-target="#feedActionVideo"> <i
                                                    class="bi bi-camera-reels-fill text-info pe-2"></i>Video</a>
                                        </li>
                                    </ul>
                                </div>
                                {% endif %}
                                <!-- Share feed END -->

                                <!-- Card feed items -->
                                {% for message in group_messages %}
                                <div class="card">
                                    <div class="card-header border-0 pb-0">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <div class="avatar avatar-story me-2">
                                                    <img class="avatar-img rounded-circle"
                                                        src="{% static 'images/avatar/placeholder.jpg' %}" alt="">
                                                </div>
                                                <div>
                                                    <div class="nav nav-divider">
                                                        <h6 class="nav-item card-title mb-0"> <a href="#!">
                                                                {{ message.user.get_full_name|default:message.user.email }}
                                                            </a></h6>
                                                        <span class="nav-item small"> {{ message.created_at|timesince }}
                                                            ago</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p>{{ message.content }}</p>
                                        {% if message.image %}
                                        <img class="card-img" src="{{ message.image.url }}" alt="Post">
                                        {% endif %}
                                        {% if message.video %}
                                        <video class="w-100 rounded" controls>
                                            <source src="{{ message.video.url }}" type="video/mp4">
                                        </video>
                                        {% endif %}

                                        <ul class="nav nav-stack py-3 small">
                                            <li class="nav-item">
                                                <form action="{% url 'groups:like_message' message.pk %}" method="POST">
                                                    {% csrf_token %}
                                                    <button type="submit"
                                                        class="nav-link border-0 bg-transparent {% if request.user in message.likes.all %}active{% endif %}">
                                                        <i class="bi bi-hand-thumbs-up-fill pe-1"></i> Liked
                                                        ({{ message.likes.count }})
                                                    </button>
                                                </form>
                                            </li>
                                            <li class="nav-item">
                                                <a class="nav-link" href="#!"> <i
                                                        class="bi bi-chat-fill pe-1"></i>Comments (
                                                    {{ message.comments.count }})</a>
                                            </li>
                                        </ul>

                                        <!-- Add comment -->
                                        <div class="d-flex mb-3">
                                            <!-- Avatar -->
                                            <div class="avatar avatar-xs me-2">
                                                <a href="#!"> <img class="avatar-img rounded-circle"
                                                        src="{% if request.user.profile.profile_picture %}{{ request.user.profile.profile_picture.url }}{% else %}{% static 'images/avatar/placeholder.jpg' %}{% endif %}"
                                                        alt="">
                                                </a>
                                            </div>
                                            <!-- Comment box  -->
                                            <form class="position-relative w-100"
                                                action="{% url 'groups:comment_message' message.pk %}" method="POST">
                                                {% csrf_token %}
                                                <textarea class="form-control pe-4 bg-light" name="content" rows="1"
                                                    placeholder="Add a comment..."></textarea>
                                                <!-- Button -->
                                                <button
                                                    class="nav-link bg-transparent px-3 position-absolute top-50 end-0 translate-middle-y border-0"
                                                    type="submit">
                                                    <i class="bi bi-send-fill text-primary"></i>
                                                </button>
                                            </form>
                                        </div>
                                        <!-- Comment wrap START -->
                                        <ul class="comment-wrap list-unstyled">
                                            {% for comment in message.comments.all %}
                                            <!-- Comment item START -->
                                            <li class="comment-item">
                                                <div class="d-flex position-relative">
                                                    <div class="comment-line-inner"></div>
                                                    <!-- Avatar -->
                                                    <div class="avatar avatar-xs">
                                                        <a href="#!"><img class="avatar-img rounded-circle"
                                                                src="{% if comment.user.profile.profile_picture %}{{ comment.user.profile.profile_picture.url }}{% else %}{% static 'images/avatar/placeholder.jpg' %}{% endif %}"
                                                                alt=""></a>
                                                    </div>
                                                    <div class="ms-2">
                                                        <!-- Comment by -->
                                                        <div class="bg-light rounded-start-top-0 p-3 rounded">
                                                            <div class="d-flex justify-content-center">
                                                                <div class="me-2">
                                                                    <h6 class="mb-1"> <a href="#!">
                                                                        {{ comment.user.get_full_name|default:comment.user.email }}
                                                                    </a></h6>
                                                                    <p class="small mb-0">{{ comment.content }}</p>
                                                                </div>
                                                                <small>{{ comment.created_at|timesince }} ago</small>
                                                            </div>
                                                        </div>
                                                        <!-- Comment react -->
                                                        <ul class="nav nav-divider py-2 small">
                                                            <li class="nav-item">
                                                                <a class="nav-link" href="#!"> Like</a>
                                                            </li>
                                                            <li class="nav-item">
                                                                <a class="nav-link" href="#!"> Reply</a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </li>
                                            <!-- Comment item END -->
                                            {% endfor %}
                                        </ul>
                                        <!-- Comment wrap END -->
                                    </div>
                                </div>
                                {% empty %}
                                <div class="card card-body text-center py-5">
                                    <p>No messages yet. Be the first to post!</p>
                                </div>
                                {% endfor %}
                            </div>

                            <div class="col-lg-4">
                                <!-- About START -->
                                <div class="card">
                                    <div class="card-header border-0 pb-0">
                                        <h5 class="card-title">About</h5>
                                    </div>
                                    <div class="card-body position-relative pt-0">
                                        <p>{{ group.description|default:"No description provided." }}</p>
                                        <ul class="list-unstyled mt-3 mb-0">
                                            <li class="mb-2"> <i class="bi bi-calendar-date fa-fw pe-1"></i> Members:
                                                <strong> {{ group.memberships.count }} </strong>
                                            </li>
                                            <li class="mb-2"> <i class="bi bi-heart fa-fw pe-1"></i> Status: <strong>
                                                    {% if group.is_private %}Private{% else %}Public{% endif %}
                                                </strong>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <!-- About END -->
                            </div>
                        </div>
                    </div>
                    <!-- Group Feed tab END -->

                    <!-- Group About tab START -->
                    <div class="tab-pane fade" id="group-tab-2">
                        <div class="card card-body">
                            <h5>About this group</h5>
                            <p>{{ group.description|linebreaks|default:"No description provided yet." }}</p>
                        </div>
                    </div>
                    <!-- Group About tab END -->

                    <!-- Group Connections tab START -->
                    <div class="tab-pane fade" id="group-tab-3">
                        <div class="card card-body">
                            <div class="row g-4">
                                {% for membership in members %}
                                <div class="col-sm-6 col-lg-4">
                                    <div class="card h-100">
                                        <div class="card-body text-center">
                                            <div class="avatar avatar-lg mb-3">
                                                <img class="avatar-img rounded-circle"
                                                    src="{% static 'images/avatar/placeholder.jpg' %}" alt="">
                                            </div>
                                            <h6 class="mb-0">
                                                {{ membership.user.get_full_name|default:membership.user.email }}</h6>
                                            <small>Joined {{ membership.joined_at|date:"M Y" }}</small>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center py-5">
                                    <p>No members found.</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <!-- Group Connections tab END -->

                    <!-- Group Media tab START -->
                    <div class="tab-pane fade" id="group-tab-4">
                        <div class="card card-body">
                            <div class="row g-3">
                                {% for item in media %}
                                <div class="col-sm-6 col-md-4 col-lg-3">
                                    <a href="{{ item.image.url }}" data-glightbox="" data-gallery="group-media">
                                        <img class="img-fluid rounded" src="{{ item.image.url }}" alt="">
                                    </a>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center py-5">
                                    <i class="display-1 text-body-secondary bi bi-film"> </i>
                                    <h4 class="mt-2 text-body">No media found</h4>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <!-- Group Media tab END -->

                    <!-- Group Videos tab START -->
                    <div class="tab-pane fade" id="group-tab-5">
                        <div class="card card-body">
                            <div class="row g-3">
                                {% for item in videos %}
                                <div class="col-sm-6 col-md-4">
                                    <video class="w-100 rounded" controls>
                                        <source src="{{ item.video.url }}" type="video/mp4">
                                    </video>
                                </div>
                                {% empty %}
                                <div class="col-12 text-center py-5">
                                    <i class="display-1 text-body-secondary bi bi-camera-reels"> </i>
                                    <h4 class="mt-2 text-body">No videos found</h4>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <!-- Group Videos tab END -->

                    <!-- Moderation tab START -->
                    {% if is_moderator %}
                    <div class="tab-pane fade" id="group-tab-moderation">
                        <div class="card card-body">
                            <h5>Pending Approvals</h5>
                            <div class="vstack gap-3 mt-3">
                                {% for membership in pending_members %}
                                <div class="d-flex align-items-center justify-content-between">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar avatar-sm me-2">
                                            <img class="avatar-img rounded-circle"
                                                src="{% static 'images/avatar/placeholder.jpg' %}" alt="">
                                        </div>
                                        <div>
                                            <h6 class="mb-0 small">{{
                                                membership.user.get_full_name|default:membership.user.email }}</h6>
                                            <p class="mb-0 smaller">Requested {{ membership.joined_at|timesince }} ago
                                            </p>
                                        </div>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <form action="{% url 'groups:group_moderate' membership.pk 'approve' %}"
                                            method="POST">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success-soft btn-xs">Approve</button>
                                        </form>
                                        <form action="{% url 'groups:group_moderate' membership.pk 'reject' %}"
                                            method="POST">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-danger-soft btn-xs">Reject</button>
                                        </form>
                                    </div>
                                </div>
                                {% empty %}
                                <p>No pending join requests.</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Moderation tab END -->

                </div>
            </div>
        </div>
    </div>
</main>

<!-- Modals for posting -->
<div class="modal fade" id="modalCreateFeed" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create post</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'groups:post_message' group.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <textarea class="form-control pe-4 fs-3 lh-1 border-0" name="content" rows="4"
                        placeholder="Share your thoughts..." autofocus></textarea>
                    <div class="mt-3">
                        <label class="form-label">Add Image (optional)</label>
                        <input type="file" name="image" accept="image/*" class="form-control">
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Add Video (optional)</label>
                        <input type="file" name="video" accept="video/*" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger-soft me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success-soft">Post</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="feedActionPhoto" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add post photo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'groups:post_message' group.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <textarea class="form-control pe-4 fs-3 lh-1 border-0" name="content" rows="2"
                        placeholder="Share your thoughts..."></textarea>
                    <div class="mt-3">
                        <input type="file" name="image" accept="image/*" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger-soft me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success-soft">Post</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="feedActionVideo" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add post video</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form action="{% url 'groups:post_message' group.pk %}" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <textarea class="form-control pe-4 fs-3 lh-1 border-0" name="content" rows="2"
                        placeholder="Share your thoughts..."></textarea>
                    <div class="mt-3">
                        <input type="file" name="video" accept="video/*" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger-soft me-2" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success-soft">Post</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock content %}